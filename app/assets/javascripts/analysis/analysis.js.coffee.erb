initializeMap = (opts={}) ->
  new Map('map_analysis', opts).map

initializePica = (map, opts={}) ->
  window.pica = new Pica.Application(
    magpieUrl: "http://localhost:3001"
    projectId: 3
    map: map
  )

  window.pica.newWorkspace(properties: {country: opts.country})

  window.router = new Backbone.Routers.AnalysisRouter()
  Backbone.history.start()


invertLocaleOnPermalink = (permalink) ->
  currentLocale = polyglot.locale()
  if currentLocale == "ar"
    locale = "en"
  else
    locale = "ar"
  permalink.replace "/#{currentLocale}/", "/#{locale}/"

setupTranslationLink = ->
  $("#language > a").on "click", (e) ->
    if window.pica.currentWorkspace.currentArea.get("id")
      e.stopPropagation()
      e.preventDefault()
      permalink = invertLocaleOnPermalink $(".permalink :text").val()
      window.location.href = permalink

$(document).ready ->
  if $('#map_analysis').length > 0
    countryName = $('#map_analysis').data('country-name')

    map = initializeMap(country: countryName)
    initializePica(map, country: countryName)

  setupTranslationLink()
